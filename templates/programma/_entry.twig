{% extends craft.app.request.isAjax and not craft.app.request.isLivePreview ? "_ajax" : "_layout" %}
{% set title = entry.title %}
{% set heroHeight = 75 %}

{% block content %}

	{# import macro's #}
	{% import "_macros/_ui" as ui %}
	{% set image = null %}
	{# Banner #}
	{% if entry.programmaBanner.one() is empty %}
		{% set image = generic.programmadefaultbanner.one() %}
	{% else %}
		{% set image = entry.programmaBanner.one() %}
	{% endif %}
	{% set rootCategory = entry.programmaStijl
		.level('1')
		.one() %}

	{% set subCategories = entry.programmaStijl
        .level('>1')
        .all() %}

	{% set backgroundImageExtraSmall = image.getUrl('bannerImageXs') %}
	{% set backgroundImageSmall = image.getUrl('bannerImageS640w') %}
	{% set backgroundImageMedium = image.getUrl('bannerImageM1280w') %}
	{% set backgroundImageLarge = image.getUrl('bannerImageL1600w') %}
	{% set backgroundImageExtraLarge = image.getUrl('bannerImageXl1920w') %}

	<div class="d-flex align-items-center justify-content-center hero">
		{# <picture style="width: 100%; height: {{heroHeight}}vh">
			<source srcset="{{ backgroundImageExtraSmall }}" media="(max-width: 639px)">
			<source srcset="{{ backgroundImageExtraLarge }}" media="(min-width: 1920px)">
			<source srcset="{{ backgroundImageLarge }}" media="(min-width: 1600px)">
			<source srcset="{{ backgroundImageMedium }}" media="(min-width: 1280px)">
			<source srcset="{{ backgroundImageSmall }}" media="(min-width: 640px)">
			<img src="{{ backgroundImageMedium }}" alt="picture of {{title}}" style="height:{{heroHeight}}vh; object-fit:cover; object-position:center; width:100%; position: relative"/>
		</picture> #}
		<picture style="width: 100%; height: {{heroHeight}}vh">
			<source srcset="{{ backgroundImageExtraLarge }}" media="(min-width: 1920px)">
			<source srcset="{{ backgroundImageLarge }}" media="(min-width: 1600px)">
			<source srcset="{{ backgroundImageMedium }}" media="(min-width: 1280px)">
			<source srcset="{{ backgroundImageSmall }}" media="(max-width: 1279px)">
			<img src="{{ backgroundImageMedium }}" alt="picture of {{title}}" style="height:{{heroHeight}}vh; object-fit:cover; object-position:center; width:100%; position: relative"/>
		</picture>

		<div class="container banner-content align-self-end" style="position: absolute; left:0; right:0;">
			<div class="row mb-2">
				<div class="col-2 col-lg-3 col-xl-2">
					{{ ui.setLogo(entry.programmaLogo.one(), "banner-logo img-fluid") }}
				</div>

				<div class="col-10 col-lg-9 col-xl-10">
					{% if rootCategory is not null %}
						{{ ui.setCategory(rootCategory) }}
					{% endif %}
					{% if subCategories is not null %}
						{% for subCategory in subCategories %}
							{{ ui.setCategory(subCategory) }}
						{% endfor %}
					{% endif %}

					<h1 id="title" data-title="{{ entry.title }}" class="mt-1 mb-0">
						<span>{{ entry.title }}</span>
					</h1>
					
			{# Haal de programma dag, begin en einduur op uit programScheme matrix (voorlopig ideale workflow) #}
			{# TODO: Deze code is (nog) niet efficient! (zie hiervoor craft docs: eager-loading) #}


			{# Eerst checken voor listen up. Indien ja: genereer een unieke uurmelding, anders: zoek per weekdag de timeslots op in het weekdag matrixveld, die gerelateerd zijn aan entry #}
				{% if entry.title == 'Listen Up' %}
					<div class="mt-1">
						<span>Alle niet-live programma-uren.</span>
					</div>

			{% else %}
				{# Zoek de weekdagen op wanneer het programma (entry) geprogrammeerd staat.  #}
				{% set weekdagen = craft.entries.section('programScheme')
					.relatedTo({
                            targetElement: entry,
                            field: 'weekdag.programma'
                        })
					.orderBy('title')
					.all() %}
				{# De string variabelen(dagen waarop wordt uitgezonden, het uur waarop wordt uitgezonden) waarmee de programmering wordt opgebouwd #}
				{% set dagString = 'Elke ' %}
				{% set timing = null %}
				{% for dag in weekdagen %}
					{% set dagCropped = dag.title|slice(3, dag.title|length)|lcfirst %}
					{% if dag == weekdagen|first %}
						{% set dagString = "#{dagString} #{dagCropped}"  %}
					{% else %}
						{% set dagString = "#{dagString}, #{dagCropped}" %}
					{% endif %}
					{# Als alle dagen in de dagString geprint zijn, afsluiten met 'van' #}
					{# {% set dagString = "#{dagString} van " %} #}
					{# Hier gaan we ervan uit dat een programma, herhalend over meerdere dagen, steeds op het zelfde uur   geprogrammeerd staat #}
					{% if dag is same as(weekdagen|last) %}
						{% set timeslot = dag.weekdag.relatedTo({
                                targetElement: entry,
                                field: 'programma'
                                }).one() %}

						{% set timing = "#{timeslot.beginuur|time('short')} tot #{timeslot.einduur|time('short')}" %}

					{% endif %}
				{% endfor %}
				{# Programmering: De eerder opgebouwde stringvariabelen worden hier samengevoegd #}
					<div class="mt-1">
						<span>{{ [dagString, timing]|join(' van ') }}</span>
					</div>
			{% endif %}
					
				</div>
			</div>
		</div>
	</div>

	<div
		role="main" class="main container">
		{# Programma inhoud #}

		<section class="row">
			<p class=" mt-0 mb-5">
				<strong>{{ entry.intro|nl2br }}</strong>
			</p>
			{{ entry.programmaInhoud }}
		</section>

		{# Bouw hier de sociale media links met bijhorende iconen op, indien deze velden ingevuld zijn #}
		{% if entry.socialMediaLinks|length %}
			<section class="row">
				<div class="col">
					<ul class="social-links">
						{% for block in entry.socialMediaLinks.all() %}
							<li>
								{% switch block.type %}
									{% case 'facebook' %}
										<a href="{{ block.facebookLink }}" target="_blank" class="social-media-link d-flex align-items-center"><img src="../images/icons/facebook.svg" alt="facebook icon" class="pe-2"/></a>
									{% case 'instagram' %}
										<a href="{{ block.instagramLink }}" target="_blank" class="social-media-link d-flex align-items-center"><img src="../images/icons/instagram.svg" alt="instagram icon" class="pe-2"/></a>
								{% endswitch %}
							</li>
						{% endfor %}
					</ul>
				</div>
			</section>
		{% endif %}

		{% if entry.cloudmix.embed is not null %}
			<div class="row mt-5">
				<div class="col">
					<h2>Herbeluister</h2>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<div class="mix-sound-cloud">
						{{ entry.cloudmix.render() }}
					</div>
				</div>
			</div>
		{% endif %}


		{# Programmanieuws overzicht #}

		{% set entries = craft.entries.type('programmanieuws')
			.relatedTo(entry)
			.limit(2) %}
		{% set prgNieuws = entries.all() %}

		{% if entries|length %}
			{# Geef deze kop een id, zodat bij paginering op deze sectie gefocused blijft #}
			<h2 class="mt-5 mb-0">Berichten</h2>

			{% paginate entries as pageInfo, pageEntries %}
			{% include "_includes/programma/programmanieuws" with { prgNieuws: pageEntries } only %}

			{{ ui.setPagination(pageInfo) }}

		{% endif %}

			{# Zoek eerst naar gelateerde stijlen op een hoger categorieniveau dan 2 #}
			{% set stijlen = entry.programmaStijl
			.level('3')
			.all() %}
			{# Indien geen matches, zoek dan op volgende categorieniveaus #}
			{% if stijlen == null %}
				{% set stijlen = entry.programmaStijl
				.level('2')
				.all() %}
			{% endif %}
			{% if stijlen == null %}
				{% set stijlen = entry.programmaStijl
				.level('1')
				.all() %}
			{% endif %}

			{% set entries = craft.entries()
		.relatedTo(stijlen)
		.id('not ' ~ entry.id)
		.limit(4)
		.all() %}

			<section>
				{% if entries|length %}
					<h2>Misschien vind je deze programma's ook leuk:</h2>

					{% include "_includes/relatedShows" with { entries: entries} only %}

				{% endif %}
				<div class="row programma-suggestie">
					<div class="col">
						<a href="/programma" class="button-secondary mt-5">Ontdek alle programma's</a>
					</div>
				</div>
			</section>
		</div>
	{% endblock %}
